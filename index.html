<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Votacions · Puntuación de Fotos</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

  <!-- Pantalla de login -->
  <section id="auth-section" class="card">
    <h1>Iniciar sesión</h1>
    <form id="loginForm">
      <label>
        Correo:
        <input type="email" id="email" required />
      </label>
      <label>
        Contraseña:
        <input type="password" id="password" required />
      </label>
      <button type="submit">Entrar</button>
    </form>
    <p><a href="#" id="forgotLink">¿Olvidaste tu contraseña?</a></p>
    <p class="hint">* Sólo usuarios autorizados (creados previamente).</p>
    <p id="loginError" class="error"></p>
  </section>

  <!-- Pantalla principal -->
  <section id="app-section" class="hidden">
    <header class="topbar">
      <div>
        <strong id="userEmail"></strong>
      </div>
      <button id="logoutBtn">Salir</button>
    </header>

    <main class="gallery">
      <div class="photo-container">
        <img id="photoImg" alt="Foto" />
        <h2 id="photoTitle"></h2>
      </div>

      <div class="controls">
        <button id="prevBtn">← Anterior</button>
        <button id="nextBtn">Siguiente →</button>
      </div>

      <div class="rating">
        <div id="stars" class="stars" aria-label="Puntuación de 1 a 5 estrellas"></div>
        <div class="current">
          Tu puntuación: <span id="myRating">—</span>
        </div>
        <p id="saveMsg" class="success"></p>
      </div>
    </main>
  </section>

  <!-- Firebase v9 modular -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { 
      getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut,
      sendPasswordResetEmail 
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { 
      getFirestore, doc, setDoc, getDoc, serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";


    // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries


// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyBJaD7hIrBr6o05pQ-y8875uoQ_jZFCX_g",
  authDomain: "votafotos-424b8.firebaseapp.com",
  projectId: "votafotos-424b8",
  storageBucket: "votafotos-424b8.firebasestorage.app",
  messagingSenderId: "730368251670",
  appId: "1:730368251670:web:570b65ddde754a82ca2237"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // UI refs
    const authSection = document.getElementById("auth-section");
    const appSection  = document.getElementById("app-section");
    const loginForm   = document.getElementById("loginForm");
    const loginError  = document.getElementById("loginError");
    const userEmailEl = document.getElementById("userEmail");
    const logoutBtn   = document.getElementById("logoutBtn");
    const forgotLink  = document.getElementById("forgotLink");

    const photoImg    = document.getElementById("photoImg");
    const photoTitle  = document.getElementById("photoTitle");
    const prevBtn     = document.getElementById("prevBtn");
    const nextBtn     = document.getElementById("nextBtn");
    const starsEl     = document.getElementById("stars");
    const myRatingEl  = document.getElementById("myRating");
    const saveMsgEl   = document.getElementById("saveMsg");

    let IMAGES = [];
    let index = 0;
    let currentUser = null;

    // PRNG determinista por usuario (orden aleatorio estable)
    function hashString(str) {
      let h = 0;
      for (let i = 0; i < str.length; i++) {
        h = (h << 5) - h + str.charCodeAt(i);
        h |= 0;
      }
      return h >>> 0;
    }
    function mulberry32(a) {
      return function() {
        let t = a += 0x6D2B79F5;
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      };
    }
    function shuffleDeterministic(arr, seed) {
      const rnd = mulberry32(seed);
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(rnd() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    // Cargar manifest y aleatorizar por usuario
    async function loadImages() {
      const res = await fetch("images.json");
      let list = await res.json();
      if (!Array.isArray(list) || list.length === 0) {
        throw new Error("images.json vacío o mal formado");
      }
      if (currentUser) {
        const seed = hashString(currentUser.uid);
        list = shuffleDeterministic(list, seed);
      }
      IMAGES = list;
    }

    // Estrellas
    function renderStars(current = 0) {
      starsEl.innerHTML = "";
      for (let i = 1; i <= 5; i++) {
        const btn = document.createElement("button");
        btn.className = "star" + (i <= current ? " filled" : "");
        btn.setAttribute("aria-label", `${i} estrellas`);
        btn.textContent = "★";
        btn.addEventListener("click", () => rate(i));
        starsEl.appendChild(btn);
      }
    }

    // Mostrar foto actual (sin estadísticas globales)
    async function showPhoto() {
      const img = IMAGES[index];
      photoImg.src = img.url;
      photoTitle.textContent = img.titulo || img.id;
      saveMsgEl.textContent = "";
      await loadMyRating(img.id);
    }

    // Navegación
    prevBtn.addEventListener("click", () => {
      index = (index - 1 + IMAGES.length) % IMAGES.length;
      showPhoto();
    });
    nextBtn.addEventListener("click", () => {
      index = (index + 1) % IMAGES.length;
      showPhoto();
    });

    // Tu puntuación
    async function loadMyRating(imageId) {
      if (!currentUser) return;
      myRatingEl.textContent = "—";
      const myDocRef = doc(db, "images", imageId, "ratings", currentUser.uid);
      const myDoc = await getDoc(myDocRef);
      const myStars = myDoc.exists() ? (myDoc.data().stars || 0) : 0;
      myRatingEl.textContent = myStars ? `${myStars}` : "—";
      renderStars(myStars);
    }

    // Guardar puntuación (1–5)
    async function rate(stars) {
      if (!currentUser) return;
      const imageId = IMAGES[index].id;
      const myDocRef = doc(db, "images", imageId, "ratings", currentUser.uid);
      await setDoc(myDocRef, {
        stars,
        userEmail: currentUser.email,
        createdAt: serverTimestamp()
      }, { merge: true });
      saveMsgEl.textContent = "¡Guardado!";
      myRatingEl.textContent = stars;
      renderStars(stars);
    }

    // Login
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      loginError.textContent = "";
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (err) {
        console.error(err);
        loginError.textContent = "Error al iniciar sesión. Verifica correo/contraseña.";
      }
    });

    // Reset de contraseña
    forgotLink.addEventListener("click", async (e) => {
      e.preventDefault();
      loginError.textContent = "";
      const email = document.getElementById("email").value.trim();
      if (!email) {
        loginError.textContent = "Introduce tu correo y pulsa de nuevo.";
        return;
      }
      try {
        await sendPasswordResetEmail(auth, email);
        loginError.textContent = "Te hemos enviado un correo para restablecer la contraseña.";
      } catch (err) {
        console.error(err);
        loginError.textContent = "No se pudo enviar el correo. Verifica el correo.";
      }
    });

    // Logout
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    // Cambio de estado Auth
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        userEmailEl.textContent = user.email || "";
        authSection.classList.add("hidden");
        appSection.classList.remove("hidden");

        await loadImages();
        index = 0;
        await showPhoto();
      } else {
        currentUser = null;
        authSection.classList.remove("hidden");
        appSection.classList.add("hidden");
      }
    });

    renderStars(0);
  </script>
</body>
</html>
