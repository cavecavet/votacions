<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Votacions · Puntuación de Fotos</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

  <!-- Pantalla de login -->
  <section id="auth-section" class="card">
    <h1>Iniciar sesión</h1>
    <form id="loginForm">
      <label>
        Correo:
        <input type="email" id="email" required />
      </label>
      <label>
        Contraseña:
        <input type="password" id="password" required />
      </label>
      <button type="submit">Entrar</button>
    </form>
    <div style="margin-top:12px">
      <button id="googleSignInBtn">Iniciar sesión con Google (para guardar en Drive)</button>
      <p class="hint">Inicia sesión con Google para permitir guardar las puntuaciones en Google Drive.</p>
    </div>
    <p><a href="#" id="forgotLink">¿Olvidaste tu contraseña?</a></p>
    <p class="hint">* Sólo usuarios autorizados (creados previamente).</p>
    <p id="loginError" class="error"></p>
  </section>

  <!-- Pantalla principal -->
  <section id="app-section" class="hidden">
    <header class="topbar">
      <div>
        <strong id="userEmail"></strong>
        <span id="googleAuthStatus" style="margin-left:12px;font-size:0.9em;color:#555">(Google: desconectado)</span>
      </div>
      <button id="logoutBtn">Salir</button>
    </header>

    <main class="gallery">
      <div class="photo-container">
        <img id="photoImg" alt="Foto" />
        <h2 id="photoTitle"></h2>
      </div>

      <div class="controls">
        <button id="prevBtn">← Anterior</button>
        <button id="nextBtn">Siguiente →</button>
      </div>

      <div class="rating">
        <div id="stars" class="stars" aria-label="Puntuación de 1 a 5 estrellas"></div>
        <div class="current">
          Tu puntuación: <span id="myRating">—</span>
        </div>
        <p id="saveMsg" class="success"></p>
        <div style="margin-top:10px">
          <button id="testLoadBtn">Probar cargar desde Drive</button>
          <button id="testSaveBtn">Probar guardar en Drive</button>
        </div>
      </div>
    </main>
  </section>

  <!-- Firebase v9 modular -->
  <script async defer src="https://apis.google.com/js/api.js"></script>
  <script>
    // Google Drive integration for storing ratings
    const GOOGLE_CLIENT_ID = "766497474466-r2vnqda41q20qkhm8psmaa4vq8ehlrti.apps.googleusercontent.com";
    const DRIVE_FILE_ID = "1klzoBYFsURXmLNR0uH1Vc6jfLTSk5U2K";

    // App state
    let IMAGES = [];
    let index = 0;
    let currentUser = null;
    let credentials = [];
    let gapi_loaded = false;

    // UI refs
    const authSection = document.getElementById("auth-section");
    const appSection  = document.getElementById("app-section");
    const loginForm   = document.getElementById("loginForm");
    const loginError  = document.getElementById("loginError");
    const userEmailEl = document.getElementById("userEmail");
    const logoutBtn   = document.getElementById("logoutBtn");
    const forgotLink  = document.getElementById("forgotLink");

    const photoImg    = document.getElementById("photoImg");
    const photoTitle  = document.getElementById("photoTitle");
    const prevBtn     = document.getElementById("prevBtn");
    const nextBtn     = document.getElementById("nextBtn");
    const starsEl     = document.getElementById("stars");
    const myRatingEl  = document.getElementById("myRating");
    const saveMsgEl   = document.getElementById("saveMsg");
    const googleSignInBtn = document.getElementById("googleSignInBtn");
    const googleAuthStatus = document.getElementById("googleAuthStatus");
    const testLoadBtn = document.getElementById("testLoadBtn");
    const testSaveBtn = document.getElementById("testSaveBtn");

    // Cargar credentials.json (lista de usuarios locales)
    async function loadCredentials() {
      try {
        const res = await fetch("credentials.json");
        const data = await res.json();
        credentials = data.users || [];
      } catch (err) {
        console.error("Error cargando credentials.json:", err);
        credentials = [];
      }
    }

    // Google API init
    function initGoogleApi() {
      gapi.load("client:auth2", async () => {
        try {
          await gapi.client.init({
            clientId: GOOGLE_CLIENT_ID,
            scope: "https://www.googleapis.com/auth/drive"
          });
          gapi_loaded = true;
          const auth = gapi.auth2.getAuthInstance();
          // Update button text according to sign-in state
          function updateGoogleButton() {
            if (auth.isSignedIn.get()) {
              googleSignInBtn.textContent = "Cerrar sesión de Google";
              googleAuthStatus.textContent = '(Google: conectado)';
              testLoadBtn.style.display = '';
              testSaveBtn.style.display = '';
            } else {
              googleSignInBtn.textContent = "Iniciar sesión con Google (para guardar en Drive)";
              googleAuthStatus.textContent = '(Google: desconectado)';
              testLoadBtn.style.display = 'none';
              testSaveBtn.style.display = 'none';
            }
          }
          auth.isSignedIn.listen(updateGoogleButton);
          updateGoogleButton();
          // When signing in, load ratings
          auth.currentUser.listen(async () => {
            if (auth.isSignedIn.get()) {
              ratings = await loadRatingsFromDrive() || ratings;
            }
          });
        } catch (err) {
          console.error("Error iniciando Google API:", err);
        }
      });
    }

    // Trigger Google sign-in / sign-out
    googleSignInBtn.addEventListener("click", async () => {
      if (!gapi_loaded) return alert('Google API no cargada aún.');
      const auth = gapi.auth2.getAuthInstance();
      if (!auth.isSignedIn.get()) {
        try {
          await auth.signIn();
          ratings = await loadRatingsFromDrive() || ratings;
          saveMsgEl.textContent = "Conectado a Google Drive.";
        } catch (err) {
          console.error('Error en signIn:', err);
          alert('No se pudo autenticar con Google.');
        }
      } else {
        await auth.signOut();
        saveMsgEl.textContent = "Sesión de Google cerrada.";
      }
    });

    // Test buttons for Drive read/write (manual test helpers)
    testLoadBtn.addEventListener('click', async () => {
      saveMsgEl.textContent = 'Cargando desde Drive...';
      const data = await loadRatingsFromDrive();
      if (data && Object.keys(data).length) {
        saveMsgEl.textContent = 'Ratings cargados desde Drive (' + Object.keys(data).length + ')';
        ratings = data;
      } else {
        saveMsgEl.textContent = 'No se encontraron ratings en Drive.';
      }
    });

    testSaveBtn.addEventListener('click', async () => {
      if (!currentUser) return alert('Inicia sesión antes.');
      // create a sample rating for the current user+current image
      const imageId = IMAGES[index] ? IMAGES[index].id : 'sample';
      const key = `${currentUser.email}_${imageId}`;
      ratings[key] = ratings[key] ? ratings[key] : 5;
      saveMsgEl.textContent = 'Guardando en Drive...';
      const ok = await saveRatingsToDrive(ratings);
      saveMsgEl.textContent = ok ? 'Guardado en Drive (prueba)' : 'Error guardando en Drive.';
    });

    // Load ratings JSON from Drive
    async function loadRatingsFromDrive() {
      if (!gapi_loaded) return {};
      try {
        const response = await gapi.client.drive.files.get({
          fileId: DRIVE_FILE_ID,
          alt: "media"
        });
        const data = JSON.parse(response.body || response.result);
        return data.ratings || {};
      } catch (err) {
        console.warn("No se pudieron cargar ratings de Drive:", err);
        return {};
      }
    }

    // Save ratings to Drive (multipart PATCH)
    async function saveRatingsToDrive(ratings) {
      if (!gapi_loaded) return false;
      try {
        const auth = gapi.auth2.getAuthInstance();
        if (!auth.isSignedIn.get()) return false;

        const fileContent = JSON.stringify({ ratings }, null, 2);
        const blob = new Blob([fileContent], { type: "application/json" });

        const metadata = { mimeType: "application/json" };

        const formData = new FormData();
        formData.append("metadata", new Blob([JSON.stringify(metadata)], { type: "application/json" }));
        formData.append("file", blob);

        const token = auth.currentUser.get().getAuthResponse().access_token;

        const response = await fetch(
          `https://www.googleapis.com/upload/drive/v3/files/${DRIVE_FILE_ID}?uploadType=multipart`,
          {
            method: "PATCH",
            headers: { Authorization: `Bearer ${token}` },
            body: formData
          }
        );

        return response.ok;
      } catch (err) {
        console.error("Error guardando en Drive:", err);
        return false;
      }
    }

    // Deterministic shuffle helpers
    function hashString(str) {
      let h = 0;
      for (let i = 0; i < str.length; i++) {
        h = (h << 5) - h + str.charCodeAt(i);
        h |= 0;
      }
      return h >>> 0;
    }
    function mulberry32(a) {
      return function() {
        let t = a += 0x6D2B79F5;
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      };
    }
    function shuffleDeterministic(arr, seed) {
      const rnd = mulberry32(seed);
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(rnd() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    // Load images manifest
    async function loadImages() {
      try {
        const res = await fetch("images.json");
        let list = await res.json();
        if (!Array.isArray(list) || list.length === 0) throw new Error("images.json vacío o mal formado");
        if (currentUser) {
          const seed = hashString(currentUser.email);
          list = shuffleDeterministic(list, seed);
        }
        IMAGES = list;
      } catch (err) {
        console.error("Error cargando imágenes:", err);
        IMAGES = [];
      }
    }

    // Stars UI
    function renderStars(current = 0) {
      starsEl.innerHTML = "";
      for (let i = 1; i <= 5; i++) {
        const btn = document.createElement("button");
        btn.className = "star" + (i <= current ? " filled" : "");
        btn.setAttribute("aria-label", `${i} estrellas`);
        btn.textContent = "★";
        btn.addEventListener("click", () => rate(i));
        starsEl.appendChild(btn);
      }
    }

    async function showPhoto() {
      if (!IMAGES[index]) return;
      const img = IMAGES[index];
      photoImg.src = img.url;
      photoTitle.textContent = img.titulo || img.id;
      saveMsgEl.textContent = "";
      await loadMyRating(img.id);
    }

    prevBtn.addEventListener("click", () => { index = (index - 1 + IMAGES.length) % IMAGES.length; showPhoto(); });
    nextBtn.addEventListener("click", () => { index = (index + 1) % IMAGES.length; showPhoto(); });

    // Ratings storage (session variable and Drive)
    let ratings = {};

    async function loadMyRating(imageId) {
      if (!currentUser) return;
      const key = `${currentUser.email}_${imageId}`;
      const stars = ratings[key] || 0;
      myRatingEl.textContent = stars ? `${stars}` : "—";
      renderStars(stars);
    }

    async function rate(stars) {
      if (!currentUser) return;
      const imageId = IMAGES[index].id;
      const key = `${currentUser.email}_${imageId}`;
      ratings[key] = stars;
      const saved = await saveRatingsToDrive(ratings);
      saveMsgEl.textContent = saved ? "¡Guardado en Drive!" : "¡Guardado localmente!";
      myRatingEl.textContent = stars;
      renderStars(stars);
    }

    // Login (local credentials.json)
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      loginError.textContent = "";
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      const user = credentials.find(u => u.email === email && u.password === password);
      if (user) {
        currentUser = { email };
        userEmailEl.textContent = email;
        // Load ratings from Drive if signed in
        ratings = await loadRatingsFromDrive();
        authSection.classList.add("hidden");
        appSection.classList.remove("hidden");
        await loadImages();
        index = 0;
        await showPhoto();
      } else {
        loginError.textContent = "Email o contraseña incorrectos.";
      }
    });

    forgotLink.addEventListener("click", (e) => { e.preventDefault(); loginError.textContent = "Contacta al administrador."; });

    logoutBtn.addEventListener("click", async () => {
      if (Object.keys(ratings).length > 0) await saveRatingsToDrive(ratings);
      currentUser = null; ratings = {};
      authSection.classList.remove("hidden");
      appSection.classList.add("hidden");
      loginForm.reset();
    });

    // Inicializar
    (async () => {
      initGoogleApi();
      await loadCredentials();
      renderStars(0);
    })();
  </script>
    const logoutBtn   = document.getElementById("logoutBtn");
    const forgotLink  = document.getElementById("forgotLink");

    const photoImg    = document.getElementById("photoImg");
    const photoTitle  = document.getElementById("photoTitle");
    const prevBtn     = document.getElementById("prevBtn");
    const nextBtn     = document.getElementById("nextBtn");
    const starsEl     = document.getElementById("stars");
    const myRatingEl  = document.getElementById("myRating");
    const saveMsgEl   = document.getElementById("saveMsg");

    let IMAGES = [];
    let index = 0;
    let currentUser = null;

    // PRNG determinista por usuario (orden aleatorio estable)
    function hashString(str) {
      let h = 0;
      for (let i = 0; i < str.length; i++) {
        h = (h << 5) - h + str.charCodeAt(i);
        h |= 0;
      }
      return h >>> 0;
    }
    function mulberry32(a) {
      return function() {
        let t = a += 0x6D2B79F5;
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      };
    }
    function shuffleDeterministic(arr, seed) {
      const rnd = mulberry32(seed);
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(rnd() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    // Cargar manifest y aleatorizar por usuario
    async function loadImages() {
      const res = await fetch("images.json");
      let list = await res.json();
      if (!Array.isArray(list) || list.length === 0) {
        throw new Error("images.json vacío o mal formado");
      }
      if (currentUser) {
        const seed = hashString(currentUser.uid);
        list = shuffleDeterministic(list, seed);
      }
      IMAGES = list;
    }

    // Estrellas
    function renderStars(current = 0) {
      starsEl.innerHTML = "";
      for (let i = 1; i <= 5; i++) {
        const btn = document.createElement("button");
        btn.className = "star" + (i <= current ? " filled" : "");
        btn.setAttribute("aria-label", `${i} estrellas`);
        btn.textContent = "★";
        btn.addEventListener("click", () => rate(i));
        starsEl.appendChild(btn);
      }
    }

    // Mostrar foto actual (sin estadísticas globales)
    async function showPhoto() {
      const img = IMAGES[index];
      photoImg.src = img.url;
      photoTitle.textContent = img.titulo || img.id;
      saveMsgEl.textContent = "";
      await loadMyRating(img.id);
    }

    // Navegación
    prevBtn.addEventListener("click", () => {
      index = (index - 1 + IMAGES.length) % IMAGES.length;
      showPhoto();
    });
    nextBtn.addEventListener("click", () => {
      index = (index + 1) % IMAGES.length;
      showPhoto();
    });

    // Tu puntuación
    async function loadMyRating(imageId) {
      if (!currentUser) return;
      myRatingEl.textContent = "—";
      const myDocRef = doc(db, "images", imageId, "ratings", currentUser.uid);
      const myDoc = await getDoc(myDocRef);
      const myStars = myDoc.exists() ? (myDoc.data().stars || 0) : 0;
      myRatingEl.textContent = myStars ? `${myStars}` : "—";
      renderStars(myStars);
    }

    // Guardar puntuación (1–5)
    async function rate(stars) {
      if (!currentUser) return;
      const imageId = IMAGES[index].id;
      const myDocRef = doc(db, "images", imageId, "ratings", currentUser.uid);
      await setDoc(myDocRef, {
        stars,
        userEmail: currentUser.email,
        createdAt: serverTimestamp()
      }, { merge: true });
      saveMsgEl.textContent = "¡Guardado!";
      myRatingEl.textContent = stars;
      renderStars(stars);
    }

    // Login
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      loginError.textContent = "";
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      try {
        await signInWithEmailAndPassword(auth, email, password);
      } catch (err) {
        console.error(err);
        loginError.textContent = "Error al iniciar sesión. Verifica correo/contraseña.";
      }
    });

    // Reset de contraseña
    forgotLink.addEventListener("click", async (e) => {
      e.preventDefault();
      loginError.textContent = "";
      const email = document.getElementById("email").value.trim();
      if (!email) {
        loginError.textContent = "Introduce tu correo y pulsa de nuevo.";
        return;
      }
      try {
        await sendPasswordResetEmail(auth, email);
        loginError.textContent = "Te hemos enviado un correo para restablecer la contraseña.";
      } catch (err) {
        console.error(err);
        loginError.textContent = "No se pudo enviar el correo. Verifica el correo.";
      }
    });

    // Logout
    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    // Cambio de estado Auth
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        userEmailEl.textContent = user.email || "";
        authSection.classList.add("hidden");
        appSection.classList.remove("hidden");

        await loadImages();
        index = 0;
        await showPhoto();
      } else {
        currentUser = null;
        authSection.classList.remove("hidden");
        appSection.classList.add("hidden");
      }
    });

    renderStars(0);
  </script>
</body>
</html>
