<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Votacions · Puntuación de Fotos</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

  <!-- Pantalla de login -->
  <section id="auth-section" class="card">
    <h1>Iniciar sesión</h1>
    <form id="loginForm">
      <label>
        Correo:
        <input type="email" id="email" autocomplete="email" required />
      </label>
      <label>
        Contraseña:
        <input type="password" id="password" autocomplete="current-password" required />
      </label>
      <button type="submit">Entrar</button>
    </form>
    <p><a href="#" id="forgotLink">¿Olvidaste tu contraseña?</a></p>
    <p class="hint">* Usuario: prueba@ejemplo.com | Contraseña: prueBa123!</p>
    <p id="loginError" class="error"></p>
  </section>

  <!-- Pantalla principal -->
  <section id="app-section" class="hidden">
    <header class="topbar">
      <div>
        <strong id="userEmail"></strong>
      </div>
      <button id="logoutBtn">Salir</button>
    </header>

    <main class="gallery">
      <div class="photo-container">
        <img id="photoImg" alt="Foto" />
        <h2 id="photoTitle"></h2>
      </div>

      <div class="controls">
        <button id="prevBtn">← Anterior</button>
        <button id="nextBtn">Siguiente →</button>
      </div>

      <div class="rating">
        <div id="stars" class="stars" aria-label="Puntuación de 1 a 5 estrellas"></div>
        <div class="current">
          Tu puntuación: <span id="myRating">—</span>
        </div>
        <p id="saveMsg" class="success"></p>
      </div>
    </main>
  </section>

  <script>
    // App state
    let IMAGES = [];
    let index = 0;
    let currentUser = null;
    let credentials = [];
    let ratings = {};

    // UI refs
    const authSection = document.getElementById("auth-section");
    const appSection  = document.getElementById("app-section");
    const loginForm   = document.getElementById("loginForm");
    const loginError  = document.getElementById("loginError");
    const userEmailEl = document.getElementById("userEmail");
    const logoutBtn   = document.getElementById("logoutBtn");
    const forgotLink  = document.getElementById("forgotLink");

    const photoImg    = document.getElementById("photoImg");
    const photoTitle  = document.getElementById("photoTitle");
    const prevBtn     = document.getElementById("prevBtn");
    const nextBtn     = document.getElementById("nextBtn");
    const starsEl     = document.getElementById("stars");
    const myRatingEl  = document.getElementById("myRating");
    const saveMsgEl   = document.getElementById("saveMsg");

    // Cargar credentials.json
    async function loadCredentials() {
      try {
        const res = await fetch("credentials.json");
        const data = await res.json();
        credentials = data.users || [];
        console.log('Credentials loaded:', credentials.length, 'users');
      } catch (err) {
        console.error("Error cargando credentials.json:", err);
        credentials = [];
      }
    }

    // Deterministic shuffle helpers
    function hashString(str) {
      let h = 0;
      for (let i = 0; i < str.length; i++) {
        h = (h << 5) - h + str.charCodeAt(i);
        h |= 0;
      }
      return h >>> 0;
    }
    function mulberry32(a) {
      return function() {
        let t = a += 0x6D2B79F5;
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      };
    }
    function shuffleDeterministic(arr, seed) {
      const rnd = mulberry32(seed);
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(rnd() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    // Load images manifest
    async function loadImages() {
      try {
        const res = await fetch("images.json");
        let list = await res.json();
        if (!Array.isArray(list) || list.length === 0) throw new Error("images.json vacío o mal formado");
        if (currentUser) {
          const seed = hashString(currentUser.email);
          list = shuffleDeterministic(list, seed);
        }
        IMAGES = list;
      } catch (err) {
        console.error("Error cargando imágenes:", err);
        IMAGES = [];
      }
    }

    // Stars UI
    function renderStars(current = 0) {
      starsEl.innerHTML = "";
      for (let i = 1; i <= 5; i++) {
        const btn = document.createElement("button");
        btn.className = "star" + (i <= current ? " filled" : "");
        btn.setAttribute("aria-label", `${i} estrellas`);
        btn.textContent = "★";
        btn.addEventListener("click", () => rate(i));
        starsEl.appendChild(btn);
      }
    }

    async function showPhoto() {
      if (!IMAGES[index]) return;
      const img = IMAGES[index];
      photoImg.src = img.url;
      photoTitle.textContent = img.titulo || img.id;
      saveMsgEl.textContent = "";
      await loadMyRating(img.id);
    }

    prevBtn.addEventListener("click", () => {
      if (!IMAGES || IMAGES.length === 0) return;
      index = (index - 1 + IMAGES.length) % IMAGES.length;
      showPhoto();
    });
    nextBtn.addEventListener("click", () => {
      if (!IMAGES || IMAGES.length === 0) return;
      index = (index + 1) % IMAGES.length;
      showPhoto();
    });

    async function loadMyRating(imageId) {
      if (!currentUser) return;
      const key = `${currentUser.email}_${imageId}`;
      const stars = ratings[key] || 0;
      myRatingEl.textContent = stars ? `${stars}` : "—";
      renderStars(stars);
    }

    async function rate(stars) {
      if (!currentUser) return;
      if (!IMAGES || !IMAGES[index]) {
        console.warn('Intento de puntuar pero no hay imagen en el índice', index);
        return;
      }
      const imageId = IMAGES[index].id;
      const key = `${currentUser.email}_${imageId}`;
      ratings[key] = stars;
      saveMsgEl.textContent = "¡Guardado!";
      myRatingEl.textContent = stars;
      renderStars(stars);
    }

    // Login using local credentials.json
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      loginError.textContent = "";
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      console.log('Attempting login with email:', email);
      const user = credentials.find(u => u.email === email && u.password === password);
      if (user) {
        console.log('Login successful');
        currentUser = { email };
        userEmailEl.textContent = email;
        authSection.classList.add("hidden");
        appSection.classList.remove("hidden");
        await loadImages();
        index = 0;
        await showPhoto();
      } else {
        console.log('Login failed: invalid credentials');
        loginError.textContent = "Email o contraseña incorrectos.";
      }
    });

    forgotLink.addEventListener("click", (e) => {
      e.preventDefault();
      loginError.textContent = "Contacta al administrador para restablecer la contraseña.";
    });

    logoutBtn.addEventListener("click", async () => {
      currentUser = null;
      ratings = {};
      authSection.classList.remove("hidden");
      appSection.classList.add("hidden");
      loginForm.reset();
    });

    // Inicializar
    (async () => {
      if (typeof loadCredentials === "function") {
        await loadCredentials();
      } else {
        console.warn("loadCredentials no disponible; se continúa sin credenciales locales.");
        credentials = [];
      }
      renderStars(0);
      console.log('App initialized with local credentials');
    })();
  </script>
</body>
</html>
