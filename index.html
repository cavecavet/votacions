<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Votacions · Puntuación de Fotos</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

  <!-- Pantalla de login -->
  <section id="auth-section" class="card">
    <h1>Iniciar sesión</h1>
    <form id="loginForm">
      <label>
        Correo:
        <input type="email" id="email" autocomplete="email" required />
      </label>
      <label>
        Contraseña:
        <input type="password" id="password" autocomplete="current-password" required />
      </label>
      <button type="submit">Entrar</button>
    </form>
    <p><a href="#" id="forgotLink">¿Olvidaste tu contraseña?</a></p>
    <p class="hint">* Configura Firebase en FIREBASE_SETUP.md</p>
    <p id="loginError" class="error"></p>
  </section>

  <!-- Pantalla principal -->
  <section id="app-section" class="hidden">
    <header class="topbar">
      <div>
        <strong id="userEmail"></strong>
      </div>
      <div class="top-actions">
        <button id="exportBtn" title="Exportar puntuaciones">Exportar</button>
        <input id="importFile" type="file" accept="application/json" style="display:none" />
        <button id="importBtn" title="Importar puntuaciones">Importar</button>
        <button id="saveGithubBtn" title="Guardar votaciones en GitHub">Guardar en GitHub</button>
        <button id="resetOrderBtn" title="Reiniciar orden">Reiniciar orden</button>
        <span id="progress" class="progress" aria-live="polite"></span>
        <button id="logoutBtn">Salir</button>
      </div>
    </header>

    <main class="gallery">
      <div class="photo-container">
        <img id="photoImg" alt="Foto" />
        <h2 id="photoTitle"></h2>
      </div>

      <div class="controls">
        <button id="prevBtn">← Anterior</button>
        <button id="nextBtn">Siguiente →</button>
      </div>

      <div class="rating">
        <div id="stars" class="stars" aria-label="Puntuación de 1 a 5 estrellas"></div>
        <div class="current">
          Tu puntuación: <span id="myRating">—</span>
        </div>
        <p id="saveMsg" class="success"></p>
      </div>
    </main>
  </section>

  <script type="module">
    // Firebase Config (update with your config from Firebase Console)
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyBJaD7hIrBr6o05pQ-y8875uoQ_jZFCX_g",
  authDomain: "votafotos-424b8.firebaseapp.com",
  projectId: "votafotos-424b8",
  storageBucket: "votafotos-424b8.firebasestorage.app",
  messagingSenderId: "730368251670",
  appId: "1:730368251670:web:570b65ddde754a82ca2237"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);

    // App state
    let IMAGES = [];
    let index = 0;
    let currentUser = null;
    let credentials = [];
    let ratings = {};

    // UI refs
    const authSection = document.getElementById("auth-section");
    const appSection  = document.getElementById("app-section");
    const loginForm   = document.getElementById("loginForm");
    const loginError  = document.getElementById("loginError");
    const userEmailEl = document.getElementById("userEmail");
    const logoutBtn   = document.getElementById("logoutBtn");
    const forgotLink  = document.getElementById("forgotLink");

    const photoImg    = document.getElementById("photoImg");
    const photoTitle  = document.getElementById("photoTitle");
    const prevBtn     = document.getElementById("prevBtn");
    const nextBtn     = document.getElementById("nextBtn");
    const starsEl     = document.getElementById("stars");
    const myRatingEl  = document.getElementById("myRating");
    const saveMsgEl   = document.getElementById("saveMsg");
    const exportBtn   = document.getElementById("exportBtn");
    const importBtn   = document.getElementById("importBtn");
    const importFile  = document.getElementById("importFile");
    const saveGithubBtn = document.getElementById("saveGithubBtn");
    const resetOrderBtn = document.getElementById("resetOrderBtn");
    const progressEl  = document.getElementById("progress");

    // Firebase Config (update with your config from Firebase Console)
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    // Firebase v9 imports
    let auth, firestore;
    async function initFirebase() {
      try {
        const { initializeApp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js');
        const { getAuth, onAuthStateChanged } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
        const { getFirestore } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        
        const app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        firestore = getFirestore(app);
        console.log('Firebase initialized');
        
        onAuthStateChanged(auth, (user) => {
          if (user) {
            console.log('User logged in:', user.email);
            currentUser = { email: user.email, uid: user.uid };
            userEmailEl.textContent = user.email;
            authSection.classList.add("hidden");
            appSection.classList.remove("hidden");
            loadImages();
            loadRatingsFromLocalStorage();
            index = 0;
            showPhoto();
          } else {
            console.log('User not logged in');
            currentUser = null;
            authSection.classList.remove("hidden");
            appSection.classList.add("hidden");
          }
        });
      } catch (err) {
        console.error('Error initializing Firebase:', err);
        loginError.textContent = 'Error inicializando Firebase. Revisa la consola y la configuración.';
      }
    }

    // Deterministic shuffle helpers
    function hashString(str) {
      let h = 0;
      for (let i = 0; i < str.length; i++) {
        h = (h << 5) - h + str.charCodeAt(i);
        h |= 0;
      }
      return h >>> 0;
    }
    function mulberry32(a) {
      return function() {
        let t = a += 0x6D2B79F5;
        t = Math.imul(t ^ (t >>> 15), t | 1);
        t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
        return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
      };
    }
    function shuffleDeterministic(arr, seed) {
      const rnd = mulberry32(seed);
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--) {
        const j = Math.floor(rnd() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    // Load images manifest
    async function loadImages() {
      try {
        const res = await fetch("images.json");
        let list = await res.json();
        if (!Array.isArray(list) || list.length === 0) throw new Error("images.json vacío o mal formado");
        if (currentUser) {
          const seed = hashString(currentUser.email);
          list = shuffleDeterministic(list, seed);
        }
        IMAGES = list;
      } catch (err) {
        console.error("Error cargando imágenes:", err);
        IMAGES = [];
      }
    }

    // Stars UI
    function renderStars(current = 0) {
      starsEl.innerHTML = "";
      for (let i = 1; i <= 5; i++) {
        const btn = document.createElement("button");
        btn.className = "star" + (i <= current ? " filled" : "");
        btn.setAttribute("aria-label", `${i} estrellas`);
        btn.textContent = "★";
        btn.addEventListener("click", () => rate(i));
        starsEl.appendChild(btn);
      }
    }

    async function showPhoto() {
      if (!IMAGES[index]) return;
      const img = IMAGES[index];
      photoImg.src = img.url;
      photoTitle.textContent = img.titulo || img.id;
      saveMsgEl.textContent = "";
      await loadMyRating(img.id);
      preloadNext();
      updateProgress();
    }

    function updateProgress() {
      if (!IMAGES || IMAGES.length === 0) {
        progressEl.textContent = '';
        return;
      }
      progressEl.textContent = `Foto ${index+1} de ${IMAGES.length}`;
    }

    function preloadNext() {
      const nextIdx = (index + 1) % (IMAGES.length || 1);
      const next = IMAGES[nextIdx];
      if (!next) return;
      const img = new Image();
      img.src = next.url;
    }

    prevBtn.addEventListener("click", () => {
      if (!IMAGES || IMAGES.length === 0) return;
      index = (index - 1 + IMAGES.length) % IMAGES.length;
      showPhoto();
    });
    nextBtn.addEventListener("click", () => {
      if (!IMAGES || IMAGES.length === 0) return;
      index = (index + 1) % IMAGES.length;
      showPhoto();
    });

    async function loadMyRating(imageId) {
      if (!currentUser) return;
      const key = `${currentUser.email}_${imageId}`;
      const stars = ratings[key] || 0;
      myRatingEl.textContent = stars ? `${stars}` : "—";
      renderStars(stars);
    }

    async function rate(stars) {
      if (!currentUser) return;
      if (!IMAGES || !IMAGES[index]) {
        console.warn('Intento de puntuar pero no hay imagen en el índice', index);
        return;
      }
      const imageId = IMAGES[index].id;
      const key = `${currentUser.email}_${imageId}`;
      ratings[key] = stars;
      saveMsgEl.textContent = "¡Guardado!";
      myRatingEl.textContent = stars;
      renderStars(stars);
      // Persist local
      saveRatingsToLocalStorage();
    }

    // Local persistence
    function saveRatingsToLocalStorage() {
      try {
        localStorage.setItem('votacions_ratings', JSON.stringify(ratings));
        console.log('Ratings saved to localStorage');
      } catch (e) {
        console.error('Error saving ratings to localStorage', e);
      }
    }
    function loadRatingsFromLocalStorage() {
      try {
        const raw = localStorage.getItem('votacions_ratings');
        if (raw) ratings = JSON.parse(raw);
        console.log('Ratings loaded from localStorage');
      } catch (e) {
        console.error('Error loading ratings from localStorage', e);
      }
    }

    // Export / Import
    exportBtn.addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(ratings, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'votacions_ratings.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });
    importBtn.addEventListener('click', () => importFile.click());
    importFile.addEventListener('change', async (e) => {
      const f = e.target.files[0];
      if (!f) return;
      try {
        const txt = await f.text();
        const obj = JSON.parse(txt);
        ratings = obj || {};
        saveRatingsToLocalStorage();
        saveMsgEl.textContent = 'Importado.';
        await loadMyRating(IMAGES[index]?.id);
      } catch (err) {
        console.error('Import error', err);
        saveMsgEl.textContent = 'Error importando.';
      }
      importFile.value = '';
    });

    // Reset order (clear seed shuffle)
    resetOrderBtn.addEventListener('click', async () => {
      if (!currentUser) return;
      await loadImages();
      index = 0;
      await showPhoto();
    });

    // Login using Firebase
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      loginError.textContent = "";
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      if (!auth) {
        loginError.textContent = 'Firebase no inicializado.';
        return;
      }
      try {
        const { signInWithEmailAndPassword } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
        await signInWithEmailAndPassword(auth, email, password);
        console.log('Login successful');
      } catch (err) {
        console.error('Login error:', err.code, err.message);
        loginError.textContent = err.message;
      }
    });

    forgotLink.addEventListener("click", async (e) => {
      e.preventDefault();
      const email = document.getElementById("email").value.trim();
      if (!email) {
        loginError.textContent = "Ingresa tu correo primero.";
        return;
      }
      if (!auth) {
        loginError.textContent = 'Firebase no inicializado.';
        return;
      }
      try {
        const { sendPasswordResetEmail } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
        await sendPasswordResetEmail(auth, email);
        loginError.textContent = 'Email de recuperación enviado.';
      } catch (err) {
        console.error('Password reset error:', err.message);
        loginError.textContent = err.message;
      }
    });

    logoutBtn.addEventListener("click", async () => {
      if (!auth) return;
      try {
        const { signOut } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
        await signOut(auth);
        currentUser = null;
        ratings = {};
        saveRatingsToLocalStorage();
        authSection.classList.remove("hidden");
        appSection.classList.add("hidden");
        loginForm.reset();
      } catch (err) {
        console.error('Logout error:', err);
      }
    });

    // Keyboard navigation and star keyboard support
    document.addEventListener('keydown', (e) => {
      if (!currentUser) return;
      if (e.key === 'ArrowLeft') { prevBtn.click(); }
      if (e.key === 'ArrowRight') { nextBtn.click(); }
      if (e.key === 'Home') { index = 0; showPhoto(); }
      if (e.key === 'End') { index = IMAGES.length - 1; showPhoto(); }
    });

    starsEl.addEventListener('keydown', (e) => {
      const focused = document.activeElement;
      if (!focused || !focused.classList.contains('star')) return;
      const children = Array.from(starsEl.querySelectorAll('.star'));
      const idx = children.indexOf(focused);
      if (e.key === 'ArrowLeft' && idx > 0) children[idx-1].focus();
      if (e.key === 'ArrowRight' && idx < children.length-1) children[idx+1].focus();
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        focused.click();
      }
    });

    // Inicializar
    (async () => {
      await initFirebase();
      loadRatingsFromLocalStorage();
      renderStars(0);
      console.log('App initialized with Firebase');
    })();

    // --- GitHub save integration (client-side) ---
    async function getGitHubFileSha(owner, repo, path, token) {
      const url = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
      const res = await fetch(url, { headers: { Authorization: `token ${token}`, Accept: 'application/vnd.github.v3+json' } });
      if (res.status === 200) {
        const j = await res.json();
        return j.sha;
      }
      return null;
    }
    async function saveRatingsToGitHub() {
      const owner = prompt('Owner (usuario/organización):', 'cavecavet');
      if (!owner) return;
      const repo = prompt('Repositorio:', 'votacions');
      if (!repo) return;
      const path = prompt('Ruta en repo (p.e. data/ratings.json):', 'data/ratings.json');
      if (!path) return;
      const token = prompt('Personal Access Token (con scope repo) — se usará solo en esta sesión:');
      if (!token) return alert('Token requerido');

      const content = btoa(unescape(encodeURIComponent(JSON.stringify(ratings, null, 2))));
      const sha = await getGitHubFileSha(owner, repo, path, token);
      const putUrl = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;
      const body = { message: `Update ratings by ${currentUser ? currentUser.email : 'anonymous'}`, content };
      if (sha) body.sha = sha;
      const res = await fetch(putUrl, {
        method: 'PUT',
        headers: { Authorization: `token ${token}`, Accept: 'application/vnd.github.v3+json' },
        body: JSON.stringify(body)
      });
      if (res.ok) {
        saveMsgEl.textContent = 'Guardado en GitHub.';
      } else {
        const txt = await res.text();
        console.error('GitHub save error', res.status, txt);
        saveMsgEl.textContent = 'Error guardando en GitHub. Revisa la consola.';
      }
    }
    saveGithubBtn.addEventListener('click', saveRatingsToGitHub);
  </script>
</body>
</html>
